<div *ngIf="chat.memberOne === undefined">
    hola
</div>
<div *ngIf="chat.memberOne !== undefined" class="w-full h-full relative flex bg-cover bg-center"
    [ngStyle]="{'background-image': selectedBackgroundImage}" loading="lazy">
    <div class="flex absolute h-full w-[200%] overflow-auto scroll-hide">
        <div class="flex flex-col w-full h-full ">
            <div class="w-full h-[9.5rem] pt-16 bg-gray-50 bg-opacity-[0.63] overflow-hidden backdrop-blur-lg px-4">
                <div class="flex items-center justify-between h-full px-4">
                    <div class="flex items-center gap-4 overflow-hidden w-full justify-between border-2 border-black">
                        <div class="flex gap-3 items-center border-2 border-black w-max flex-shrink-0 overflow-hidden">
                            <button (click)="moveToChatList()" class="flex sm:hidden text-xl text-gray-700 pr-3 focus:outline-none">
                                <i class="fa fa-arrow-left"></i>
                            </button>
                            <div class="rounded-full overflow-hidden bg-gray-500 h-full w-10 aspect-square">
                                <img *ngIf="receiver.profilePicture" [src]="urlImage + receiver.profilePicture"
                                    alt="chat receiver image"
                                    class="flex h-full object-cover w-full items-center justify-center">
                                <div *ngIf="!receiver.profilePicture"
                                    class="flex w-full h-full justify-center items-center text-xs text-white bg-sky-600">
                                    {{ getUserInitials(receiver) }}
                                </div>
                            </div>
                            <div class="flex flex-col flex-shrink-0 justify-between w-min overflow-hidden">
                                <div class="flex items-end gap-1 flex-shrink-0 text-left align-top overflow-hidden whitespace-nowrap w-full overflow-ellipsis">
                                    <p *ngIf="chat.car" class="text-gray-800">{{ chat.car.title }} -</p>
                                    <p>{{ receiver.username }}</p>
                                </div>
                                <p class="italic text-xs text-gray-600">{{ receiver.status ? 'Online' : 'Offline' }}</p>
                            </div>
                        </div>
                        <button class="w-fit h-10 flex gap-2 items-center border-2 border-black">
                            <p>Options</p>
                            <i class="fa fa-ellipsis-vertical"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="w-auto h-full flex flex-col p-3 px-4 overflow-y-auto scroll-chat" #messageContainer>
                <div *ngFor="let message of messages; let i = index" class="w-full flex flex-col py-1">
                    <ng-container *ngIf="shouldShowDate(i)">
                        <div class="text-center w-full my-2 text-gray-700 flex justify-center">
                            <p class="py-1 px-4 w-fit text-sm bg-gray-50 backdrop-blur-sm rounded-2xl bg-opacity-55">{{
                                messages[i].sentTime | date:'fullDate' }}</p>
                        </div>
                    </ng-container>
                    <div [ngClass]="{
                                'bg-sky-500 text-white self-end': message.sender.id === currentUser.id,
                                'bg-white self-start': message.sender.id !== currentUser.id,
                                'rounded-tr-none': (i !== 0 && messages[i].sender.id !== messages[i - 1].sender.id && message.sender.id === currentUser.id) || (i === 0 && message.sender.id === currentUser.id),
                                'rounded-tl-none': (i !== 0 && messages[i].sender.id !== messages[i - 1].sender.id && message.sender.id !== currentUser.id) || (i === 0 && message.sender.id !== currentUser.id)
                              }" (dblclick)="likeMessage(message)"
                        class="bg-opacity-95 rounded-lg p-1 px-3 w-auto flex flex-col relative items-end max-w-[60%] shadow-md">
                        <span class="text-[15px] relative min-w-full justify-between">
                            <ng-container *ngFor="let line of message.content.split('\n'); let isLast=last">
                                <span *ngFor="let word of line.split(' ')" class="w-full inline select-none"
                                    [ngClass]="{'break-all': word.length > maxWidth}">
                                    {{word}}
                                </span>
                                <ng-container *ngIf="!isLast">
                                    <br>
                                </ng-container>
                            </ng-container>
                            <span class="inline-block select-none">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                            <span
                                class="text-[9px] absolute right-0 bottom-[2px] text-end self-end select-none">{{message.sentTime
                                | timeOnly}}</span>
                        </span>

                        <i [ngClass]="{'scale-0': !message.liked, 'scale-110': message.liked, '-left-6': message.sender.id === currentUser.id, '-right-6': message.sender.id !== currentUser.id}"
                            class="fa fa-heart absolute transition-all py-[3px] duration-300 text-red-500"></i>
                        <div *ngIf="messages[i].read && i === messages.length - 1 && message.sender.id === currentUser.id"
                            class="absolute items-center text-[12px] flex -bottom-5 right-1 gap-2">
                            <i class="fa fa-eye"></i>
                            <p>Seen</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-16 w-full flex px-4">
                <textarea type="text" name="message" id="message" placeholder="Type a message..." autocomplete="off"
                    [(ngModel)]="messageContent" (keypress)="handleKey($event)"
                    class="w-full items-center resize-none m-3 placeholder:italic placeholder:text-sm py-2 flex text rounded-xl sm:rounded-md px-3 bg-white max-h-full h-10 focus:outline-none bg-opacity-80 backdrop-blur-md"></textarea>

                <button (click)="sendMessage()"
                    class="bg-sky-600 m-3 py-2 h-10 rounded-full sm:rounded-md items-center flex gap-2 text-white px-4 hover:bg-sky-700 transition-all duration-300">
                    <p class="hidden sm:flex">Send</p>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-send-2" width="24"
                        height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path
                            d="M4.698 4.034l16.302 7.966l-16.302 7.966a.503 .503 0 0 1 -.546 -.124a.555 .555 0 0 1 -.12 -.568l2.468 -7.274l-2.468 -7.274a.555 .555 0 0 1 .12 -.568a.503 .503 0 0 1 .546 -.124z" />
                        <path d="M6.5 12h14.5" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="flex flex-col bg-gray-50 bg-opacity-[0.63] pt-16 backdrop-blur-lg w-full gap-5">
            <div class="border-2 border-black h-16 flex justify-start items-center">
                <button class="px-4 gap-2 flex items-center">
                    <i class="fa fa-arrow-left"></i>
                    <p class="">Go back</p>
                </button>
            </div>
            <div class="flex flex-col lg:flex-row gap-10">
                <div class="flex flex-col px-10 gap-5 w-2/5">
                    <label for="User" class="text-lg">User info:</label>
                    <div class="flex w-full flex-col md:flex-row xl:flex-col gap-3 md:gap-5 justify-start text-gray-800">
                        <div [routerLink]="['/user', receiver.id]"
                            class="rounded-lg cursor-pointer overflow-hidden bg-gray-500 h-full w-28 md:w-40 xl:w-80 aspect-square">
                            <img *ngIf="receiver.profilePicture" [src]="urlImage + receiver.profilePicture"
                                alt="chat receiver image"
                                class="flex h-full object-cover w-full items-center justify-center">
                            <div *ngIf="!receiver.profilePicture"
                                class="flex w-full h-full justify-center items-center text-xs text-white bg-sky-600">
                                {{ getUserInitials(receiver) }}
                            </div>
                        </div>
                        <div class="flex flex-col justify-start items-start gap-2 md:gap-3 w-full">
                            <p class="md:text-xl">{{receiver.name}} {{receiver.lastname}}</p>
                            <p class="text-sm md:text-base">@{{ receiver.username }}</p>
                            <p class="text-xs md:text-sm">
                                <i class="fa fa-phone text-gray-600 text-xs"></i>
                                {{receiver.phone}}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-5 w-3/5">
                    <label for="car" class="text-lg">Car info:</label>
                    <div class="flex flex-col w-full text-gray-800 gap-5">
                        
                        <div class="flex xl:flex-col gap-5 pr-10">
                            <div class="relative h-28 md:h-40 xl:h-80 w-80 xl:w-full">
                                <a [routerLink]="['/car', chat.car.id]" class="h-full w-full focus:outline-none flex">
                                    <img *ngIf="chat.car && chat.car.images && chat.car.images.length > imageIndex"
                                        class="absolute transition-shadow object-cover w-full h-full hover:shadow-lg rounded-xl"
                                        [src]="urlImage + chat.car.images[imageIndex].imageUrl">
                                </a>
                                <button *ngIf="imageIndex > 0"
                                    class="absolute focus:outline-none top-1/2 -translate-y-1/2 hover:bg-white hover:bg-opacity-25 hover:backdrop-blur-sm p-3 left-2 rounded-lg text-3xl text-white transition-colors hover:text-gray-800"
                                    (click)="prevImage()">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="flex justify-center w-full absolute bottom-0">
                                    <div class="space-x-2 bg-white bg-opacity-20 backdrop-blur-sm py-2 px-3 rounded-t-lg">
                                        <button *ngFor="let image of chat.car.images; let i = index"
                                            class="w-5 h-2 rounded-md hover:bg-gray-300 transition-colors cursor-pointer"
                                            [ngClass]="{'bg-gray-700': imageIndex === i, 'bg-gray-100': imageIndex !== i}"
                                            (click)="changePage(i)">
                                        </button>
                                    </div>
                                </div>
                                <button *ngIf="chat.car && chat.car.images && imageIndex < chat.car.images.length - 1"
                                    class="absolute focus:outline-none top-1/2 -translate-y-1/2 hover:bg-white hover:bg-opacity-25 hover:backdrop-blur-sm p-3 right-2 rounded-lg text-3xl text-white transition-colors hover:text-gray-800"
                                    (click)="nextImage()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            
                            <div class="flex flex-col gap-3 items-start justify-start w-full">
                                <p class="flex-shrink-0 text-left text-xl align-top overflow-hidden whitespace-nowrap w-[90%] xl:w-full overflow-ellipsis">{{chat.car.title}}</p>
                                <p class="text-base">{{chat.car.price | thousandSeparator}} {{chat.car.currency}}</p>
                                <div class="flex flex-col gap-2">
                                    <p class="text-sm flex gap-2 items-center"><i class="fas fa-map-marker-alt text-gray-600"></i>{{chat.car.city}}</p>
                                    <p class="text-sm flex gap-2 items-center"><i class="fas fa-tag text-gray-600"></i>{{chat.car.color | capitalizeFirst}}</p>
                                    <p class="text-sm flex gap-2 items-center"><i class="fas fa-calendar-alt text-gray-600"></i>{{chat.car.year}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>